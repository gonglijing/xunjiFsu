<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HuShu智能网关 - 历史数据</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #0a0a1a 100%);
            min-height: 100vh;
            color: #fff;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }
        
        .nav {
            background: rgba(10, 15, 35, 0.95);
            border-bottom: 1px solid rgba(0, 198, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 50;
            padding: 16px 0;
        }
        .nav-inner { display: flex; justify-content: space-between; align-items: center; }
        .nav-brand { display: flex; align-items: center; gap: 16px; }
        .nav-logo {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .nav-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #00c6ff, #00ffff, #8a2be2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .nav-subtitle { font-size: 12px; color: #9ca3af; display: flex; align-items: center; gap: 8px; }
        .nav-subtitle span { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; animation: pulse 2s infinite; }
        .nav-links { display: flex; gap: 24px; align-items: center; }
        .nav-link {
            color: rgba(0, 198, 255, 0.6);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
        }
        .nav-link:hover, .nav-link.active { color: #00c6ff; }
        .nav-link.active { background: rgba(0, 198, 255, 0.1); }
        .nav-user {
            display: flex; align-items: center; gap: 12px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        .nav-user-avatar {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
        }
        
        .card {
            background: rgba(10, 15, 35, 0.9);
            border: 1px solid rgba(0, 198, 255, 0.15);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
        }
        .btn-primary { background: rgba(0, 198, 255, 0.1); border-color: rgba(0, 198, 255, 0.3); color: #00c6ff; }
        .btn-primary:hover { background: rgba(0, 198, 255, 0.25); }
        .btn-success { background: rgba(0, 255, 127, 0.1); border-color: rgba(0, 255, 127, 0.3); color: #00ff7f; }
        
        .input, .select { width: 100%; padding: 12px 16px; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(0, 198, 255, 0.2); border-radius: 10px; color: #fff; font-size: 14px; }
        
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        .gap-4 { gap: 16px; }
        .gap-6 { gap: 24px; }
        
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .mb-8 { margin-bottom: 32px; }
        .mt-4 { margin-top: 16px; }
        .p-6 { padding: 24px; }
        .p-8 { padding: 32px; }
        
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .space-x-2 { gap: 8px; }
        .space-x-4 { gap: 16px; }
        .space-x-8 { gap: 32px; }
        
        .text-white { color: #fff; }
        .text-gray-300 { color: #d1d5db; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-blue-400 { color: #60a5fa; }
        .text-green-400 { color: #4ade80; }
        .text-sm { font-size: 14px; }
        .text-lg { font-size: 18px; }
        .text-xl { font-size: 20px; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .font-mono { font-family: 'SF Mono', Monaco, monospace; }
        
        .hidden { display: none; }
        .w-full { width: 100%; }
        .rounded-lg { border-radius: 10px; }
        .rounded-xl { border-radius: 16px; }
        .overflow-hidden { overflow: hidden; }
        .overflow-x-auto { overflow-x: auto; }
        
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        @media (min-width: 768px) { .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (min-width: 1024px) { .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #00c6ff, #8a2be2); border-radius: 4px; }
        
        .border-glow { position: relative; }
        .border-glow::before {
            content: ''; position: absolute; inset: 0; border-radius: inherit; padding: 1px;
            background: linear-gradient(135deg, #00c6ff, #00ffff, #8a2be2, #00c6ff);
            background-size: 300% 300%; animation: border-rotate 4s linear infinite;
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude;
        }
        @keyframes border-rotate { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .tab-btn {
            padding: 16px 20px;
            color: rgba(0, 198, 255, 0.5);
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s;
            position: relative;
        }
        .tab-btn:hover { color: #00c6ff; }
        .tab-btn.active { color: #00c6ff; text-shadow: 0 0 15px rgba(0, 198, 255, 0.8); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #00c6ff, #8a2be2); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .table-container { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; background: rgba(0, 0, 0, 0.3); border-radius: 12px; overflow: hidden; }
        .table th {
            background: rgba(0, 198, 255, 0.1);
            padding: 16px 20px;
            text-align: left;
            font-weight: 500;
            color: #00c6ff;
            border-bottom: 1px solid rgba(0, 198, 255, 0.2);
            font-size: 14px;
        }
        .table td { padding: 16px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); color: #b0d4ff; }
        .table tr:hover td { background: rgba(0, 198, 255, 0.08); }
        
        .pagination { display: flex; align-items: center; justify-content: space-between; margin-top: 24px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); }
        .pagination-info { font-size: 14px; color: #9ca3af; }
        .pagination-info strong { color: #fff; font-weight: 600; }
        .pagination-controls { display: flex; align-items: center; gap: 8px; }
        .pagination-btn {
            padding: 8px 16px;
            background: rgba(0, 198, 255, 0.1);
            border: 1px solid rgba(0, 198, 255, 0.3);
            border-radius: 8px;
            color: #00c6ff;
            cursor: pointer;
            transition: all 0.3s;
        }
        .pagination-btn:hover:not(:disabled) { background: rgba(0, 198, 255, 0.25); }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-page { padding: 8px 16px; color: #d1d5db; }
        
        .empty-state { text-align: center; padding: 64px 32px; }
        .empty-icon { width: 96px; height: 96px; border-radius: 50%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; font-size: 48px; color: #4b5563; }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <nav class="nav">
        <div class="container nav-inner">
            <div class="nav-brand">
                <div class="nav-logo">&#128337;</div>
                <div>
                    <div class="nav-title">HuShu智能网关</div>
                    <div class="nav-subtitle"><span></span>历史数据查询</div>
                </div>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">&#8962; 仪表盘</a>
                <a href="/realtime" class="nav-link">&#128200; 实时数据</a>
                <a href="/history" class="nav-link active">&#128337; 历史数据</a>
                <div class="nav-user">
                    <div class="nav-user-avatar">&#128100;</div>
                    <span class="text-gray-300">admin</span>
                </div>
                <a href="/logout" class="btn" style="background: rgba(255,0,63,0.1); border-color: rgba(255,0,63,0.3); color: #ff003f; padding: 8px 16px;">&#10145; 退出</a>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <main class="container" style="padding-top: 32px; padding-bottom: 32px;">
        <!-- 查询条件 -->
        <div class="card border-glow mb-8">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 24px; display: flex; align-items: center; gap: 8px; color: #60a5fa;">&#128269; 查询条件</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label style="display: block; font-size: 14px; color: #d1d5db; margin-bottom: 8px;">&#128268; 设备</label>
                    <select id="history-device-select" class="select">
                        <option value="">-- 所有设备 --</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; font-size: 14px; color: #d1d5db; margin-bottom: 8px;">&#128197; 开始时间</label>
                    <input type="datetime-local" id="history-start-time" class="input">
                </div>
                <div>
                    <label style="display: block; font-size: 14px; color: #d1d5db; margin-bottom: 8px;">&#128197; 结束时间</label>
                    <input type="datetime-local" id="history-end-time" class="input">
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button class="btn btn-success w-full justify-center" onclick="queryHistory()">&#128269; 查询</button>
                </div>
            </div>
        </div>

        <!-- 结果展示 -->
        <div class="card border-glow">
            <!-- 标签页切换 -->
            <div style="border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; gap: 8px; padding: 0 16px;">
                <button onclick="switchHistoryTab('table')" id="tab-table-btn" class="tab-btn active">&#128196; 表格视图</button>
                <button onclick="switchHistoryTab('chart')" id="tab-chart-btn" class="tab-btn">&#128202; 图表视图</button>
            </div>
            
            <!-- 标签内容 -->
            <div style="padding: 24px;">
                <!-- 表格视图 -->
                <div id="view-table" class="tab-content active">
                    <div class="table-container">
                        <table class="table">
                            <thead><tr><th>&#128197; 采集时间</th><th>&#128268; 设备</th><th>&#128268; 字段</th><th>&#128178; 数值</th><th>&#128203; 单位</th></tr></thead>
                            <tbody id="history-table-body">
                                <tr><td colspan="5" class="text-center p-8 text-gray-500">请设置查询条件并点击查询</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- 分页 -->
                    <div class="pagination">
                        <div class="pagination-info">共 <strong id="history-total">0</strong> 条记录</div>
                        <div class="pagination-controls">
                            <button class="pagination-btn" onclick="prevHistoryPage()" id="prev-page-btn">&#9664;</button>
                            <span class="pagination-page" id="history-page">1 / 1</span>
                            <button class="pagination-btn" onclick="nextHistoryPage()" id="next-page-btn">&#9654;</button>
                        </div>
                    </div>
                </div>
                
                <!-- 图表视图 -->
                <div id="view-chart" class="tab-content">
                    <div id="chart-container" style="width:100%;height:400px;display:flex;align-items:center;justify-content:center;" class="empty-state">
                        <div class="text-center">
                            <div class="empty-icon">&#128202;</div>
                            <p class="text-xl mb-2" style="color: #9ca3af;">图表数据展示区域</p>
                            <p class="text-sm" style="color: #6b7280;">请先执行查询操作</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        var historyPage = 1;
        var historyPageSize = 50;
        var historyTotal = 0;
        
        function api(url, options) {
            return fetch(url, options).then(function(res) {
                if (!res.ok) throw new Error();
                return res.json();
            });
        }
        
        function formatDateTimeLocal(date) {
            var year = date.getFullYear();
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            var hours = String(date.getHours()).padStart(2, '0');
            var minutes = String(date.getMinutes()).padStart(2, '0');
            return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
        }
        
        function switchHistoryTab(tab) {
            document.getElementById('tab-table-btn').classList.remove('active');
            document.getElementById('tab-chart-btn').classList.remove('active');
            document.getElementById('view-table').classList.remove('active');
            document.getElementById('view-chart').classList.remove('active');
            document.getElementById('tab-' + tab + '-btn').classList.add('active');
            document.getElementById('view-' + tab).classList.add('active');
        }
        
        function queryHistory() {
            var deviceId = document.getElementById('history-device-select').value;
            var startTime = document.getElementById('history-start-time').value;
            var endTime = document.getElementById('history-end-time').value;
            
            var url = '/api/data/points?page=' + historyPage + '&page_size=' + historyPageSize;
            if (deviceId) url += '&device_id=' + deviceId;
            if (startTime) url += '&start_time=' + startTime.replace('T', ' ') + ':00';
            if (endTime) url += '&end_time=' + endTime.replace('T', ' ') + ':59';
            
            api(url).then(function(response) {
                var data = response.data || response;
                historyTotal = response.total || response.length || 0;
                renderHistoryTable(data);
                updateHistoryPagination();
            });
        }
        
        function renderHistoryTable(data) {
            var tbody = document.getElementById('history-table-body');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-gray-500">未查询到历史数据</td></tr>';
                return;
            }
            var html = '';
            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                html += '<tr style="transition:background 0.2s;" onmouseover="this.style.background=\'rgba(0,198,255,0.08)\'" onmouseout="this.style.background=\'\'">';
                html += '<td style="color:#9ca3af;">' + new Date(item.collected_at).toLocaleString('zh-CN') + '</td>';
                html += '<td>' + (item.device_name || item.device_id) + '</td>';
                html += '<td style="color:#60a5fa;">' + item.field_name + '</td>';
                html += '<td style="color:#4ade80;font-family:monospace;">' + parseFloat(item.value).toFixed(2) + '</td>';
                html += '<td style="color:#6b7280;">' + getUnit(item.field_name) + '</td>';
                html += '</tr>';
            }
            tbody.innerHTML = html;
        }
        
        function updateHistoryPagination() {
            var totalPages = Math.ceil(historyTotal / historyPageSize) || 1;
            document.getElementById('history-total').textContent = historyTotal;
            document.getElementById('history-page').textContent = historyPage + ' / ' + totalPages;
            document.getElementById('prev-page-btn').disabled = historyPage <= 1;
            document.getElementById('next-page-btn').disabled = historyPage >= totalPages;
        }
        
        function prevHistoryPage() {
            if (historyPage > 1) { historyPage--; queryHistory(); }
        }
        
        function nextHistoryPage() {
            var totalPages = Math.ceil(historyTotal / historyPageSize) || 1;
            if (historyPage < totalPages) { historyPage++; queryHistory(); }
        }
        
        function getUnit(fieldName) {
            fieldName = (fieldName || '').toLowerCase();
            if (fieldName.includes('temp') || fieldName.includes('温度')) return 'C';
            if (fieldName.includes('hum') || fieldName.includes('湿度')) return '%';
            if (fieldName.includes('press') || fieldName.includes('压力')) return 'Pa';
            if (fieldName.includes('volt') || fieldName.includes('电压')) return 'V';
            if (fieldName.includes('curr') || fieldName.includes('电流')) return 'A';
            if (fieldName.includes('power') || fieldName.includes('功率')) return 'W';
            if (fieldName.includes('speed') || fieldName.includes('速度')) return 'm/s';
            if (fieldName.includes('level') || fieldName.includes('液位')) return 'm';
            if (fieldName.includes('flow') || fieldName.includes('流量')) return 'm/h';
            return '';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            var now = new Date();
            var yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            document.getElementById('history-end-time').value = formatDateTimeLocal(now);
            document.getElementById('history-start-time').value = formatDateTimeLocal(yesterday);
            
            api('/api/devices').then(function(devices) {
                var select = document.getElementById('history-device-select');
                var html = '<option value="">-- 所有设备 --</option>';
                for (var i = 0; i < devices.length; i++) {
                    html += '<option value="' + devices[i].id + '">' + devices[i].name + '</option>';
                }
                select.innerHTML = html;
            });
        });
    </script>
</body>
</html>
