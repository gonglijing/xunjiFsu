<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工业网关管理系统 - 仪表盘</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .htmx-request .htmx-indicator { display: inline; }
        .htmx-indicator { display: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 导航栏 -->
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">工业网关管理系统</h1>
            <div class="flex items-center space-x-4">
                <span id="user-info">用户</span>
                <a href="/logout" class="bg-red-500 hover:bg-red-700 px-3 py-1 rounded">退出</a>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <div class="container mx-auto px-4 py-8">
        <!-- 状态卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">采集状态</h3>
                <div id="collector-status" hx-get="/api/status" hx-trigger="load, every 5s">
                    <span class="htmx-indicator">加载中...</span>
                    <span id="status-text">未知</span>
                </div>
                <div class="mt-4">
                    <button id="start-btn" class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded mr-2"
                            hx-post="/api/collector/start" hx-target="#collector-status">
                        启动采集
                    </button>
                    <button id="stop-btn" class="bg-red-500 hover:bg-red-700 text-white px-4 py-2 rounded"
                            hx-post="/api/collector/stop" hx-target="#collector-status">
                        停止采集
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">设备统计</h3>
                <div hx-get="/api/devices" hx-trigger="load, every 30s" hx-target="#devices-container" swap="innerHTML">
                    <span class="htmx-indicator">加载中...</span>
                    <div id="devices-container"></div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">报警信息</h3>
                <div hx-get="/api/alarms" hx-trigger="load, every 10s" hx-target="this">
                    <span class="htmx-indicator">加载中...</span>
                    <div id="alarm-count">加载中...</div>
                </div>
            </div>
        </div>

        <!-- 标签页导航 -->
        <div class="mb-4">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8">
                    <button class="border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium tab-btn active"
                            data-tab="resources" onclick="switchTab('resources')">
                        资源管理
                    </button>
                    <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium tab-btn"
                            data-tab="devices" onclick="switchTab('devices')">
                        设备管理
                    </button>
                    <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium tab-btn"
                            data-tab="drivers" onclick="switchTab('drivers')">
                        驱动管理
                    </button>
                    <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium tab-btn"
                            data-tab="northbound" onclick="switchTab('northbound')">
                        北向配置
                    </button>
                    <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium tab-btn"
                            data-tab="thresholds" onclick="switchTab('thresholds')">
                        阈值配置
                    </button>
                    <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium tab-btn"
                            data-tab="alarms" onclick="switchTab('alarms')">
                        报警日志
                    </button>
                </nav>
            </div>
        </div>

        <!-- 资源管理 -->
        <div id="tab-resources" class="tab-content bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">资源列表</h3>
                <button class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded"
                        onclick="showResourceModal()">
                    添加资源
                </button>
            </div>
            <div hx-get="/api/resources" hx-trigger="load" hx-target="#resources-table">
                <span class="htmx-indicator">加载中...</span>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">配置</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="resources-table" class="bg-white divide-y divide-gray-200">
                        <!-- 数据将通过HTMX加载 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 设备管理 -->
        <div id="tab-devices" class="tab-content bg-white rounded-lg shadow p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">设备列表</h3>
                <button class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded"
                        onclick="showDeviceModal()">
                    添加设备
                </button>
            </div>
            <div hx-get="/api/devices" hx-trigger="load" hx-target="#devices-table-body" swap="innerHTML" hx-swap="innerHTML">
                <span class="htmx-indicator">加载中...</span>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">资源</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">驱动</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">采集周期</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="devices-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- 数据将通过HTMX加载 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 驱动管理 -->
        <div id="tab-drivers" class="tab-content bg-white rounded-lg shadow p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">驱动列表</h3>
                <button class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded"
                        onclick="showDriverModal()">
                    添加驱动
                </button>
            </div>
            <div hx-get="/api/drivers" hx-trigger="load" hx-target="#drivers-table">
                <span class="htmx-indicator">加载中...</span>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">文件路径</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">版本</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="drivers-table" class="bg-white divide-y divide-gray-200">
                        <!-- 数据将通过HTMX加载 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 北向配置 -->
        <div id="tab-northbound" class="tab-content bg-white rounded-lg shadow p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">北向配置列表</h3>
                <button class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded"
                        onclick="showNorthboundModal()">
                    添加配置
                </button>
            </div>
            <div hx-get="/api/northbound" hx-trigger="load" hx-target="#northbound-table">
                <span class="htmx-indicator">加载中...</span>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ProductKey</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DeviceKey</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">上报周期</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="northbound-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- 数据将通过HTMX加载 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 阈值配置 -->
        <div id="tab-thresholds" class="tab-content bg-white rounded-lg shadow p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">阈值配置列表</h3>
                <button class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded"
                        onclick="showThresholdModal()">
                    添加阈值
                </button>
            </div>
            <div hx-get="/api/thresholds" hx-trigger="load" hx-target="#thresholds-table">
                <span class="htmx-indicator">加载中...</span>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">设备</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">字段</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">条件</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">阈值</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">严重程度</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="thresholds-table" class="bg-white divide-y divide-gray-200">
                        <!-- 数据将通过HTMX加载 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 报警日志 -->
        <div id="tab-alarms" class="tab-content bg-white rounded-lg shadow p-6 hidden">
            <h3 class="text-lg font-semibold mb-4">报警日志</h3>
            <div hx-get="/api/alarms" hx-trigger="load, every 30s" hx-target="#alarms-table">
                <span class="htmx-indicator">加载中...</span>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时间</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">设备</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">字段</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">实际值</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">阈值</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">严重程度</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="alarms-table" class="bg-white divide-y divide-gray-200">
                        <!-- 数据将通过HTMX加载 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 模态框容器 -->
    <div id="modal-container" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
        <!-- 模态框内容将通过JS动态插入 -->
    </div>

    <script>
        // 标签页切换
        function switchTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            // 显示选中的标签页内容
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            // 更新标签按钮样式
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            document.querySelector('[data-tab="' + tabName + '"]').classList.remove('border-transparent', 'text-gray-500');
            document.querySelector('[data-tab="' + tabName + '"]').classList.add('border-blue-500', 'text-blue-600');
        }

        // 显示资源模态框
        function showResourceModal() {
            document.getElementById('modal-container').innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <h3 class="text-lg font-bold mb-4">添加资源</h3>
                    <form hx-post="/api/resources" hx-target="#resources-table" onclick="closeModal()">
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">名称</label>
                            <input type="text" name="name" class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">类型</label>
                            <select name="type" class="w-full border rounded px-3 py-2">
                                <option value="serial">串口</option>
                                <option value="network">网口</option>
                            </select>
                        </div>
                        <div id="serial-config">
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">串口</label>
                                <input type="text" name="port" class="w-full border rounded px-3 py-2" placeholder="/dev/ttyUSB0">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">波特率</label>
                                <input type="number" name="baud_rate" class="w-full border rounded px-3 py-2" value="9600">
                            </div>
                        </div>
                        <div id="network-config" class="hidden">
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">IP地址</label>
                                <input type="text" name="ip_address" class="w-full border rounded px-3 py-2" placeholder="192.168.1.100">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">端口</label>
                                <input type="number" name="port_num" class="w-full border rounded px-3 py-2">
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded mr-2" onclick="closeModal()">取消</button>
                            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">保存</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal-container').classList.remove('hidden');
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('modal-container').classList.add('hidden');
        }

        // 显示北向配置模态框
        function showNorthboundModal() {
            document.getElementById('modal-container').innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-[500px] shadow-lg rounded-md bg-white">
                    <h3 class="text-lg font-bold mb-4">添加北向配置</h3>
                    <form id="northbound-form">
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">名称</label>
                            <input type="text" name="name" class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">类型</label>
                            <select name="type" class="w-full border rounded px-3 py-2" onchange="toggleNorthboundConfig()">
                                <option value="xunji">XunJi</option>
                                <option value="http">HTTP</option>
                                <option value="mqtt">MQTT</option>
                            </select>
                        </div>
                        
                        <!-- XunJi 配置 -->
                        <div id="xunji-config" class="config-section">
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">ProductKey</label>
                                <input type="text" name="productKey" class="w-full border rounded px-3 py-2" placeholder="产品KEY">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">DeviceKey</label>
                                <input type="text" name="deviceKey" class="w-full border rounded px-3 py-2" placeholder="设备KEY">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">服务器地址</label>
                                <input type="text" name="serverUrl" class="w-full border rounded px-3 py-2" placeholder="mqtt://broker.example.com">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">用户名</label>
                                <input type="text" name="username" class="w-full border rounded px-3 py-2" placeholder="MQTT用户名">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">密码</label>
                                <input type="password" name="password" class="w-full border rounded px-3 py-2" placeholder="MQTT密码">
                            </div>
                        </div>
                        
                        <!-- HTTP 配置 -->
                        <div id="http-config" class="config-section hidden">
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">服务器地址</label>
                                <input type="text" name="httpUrl" class="w-full border rounded px-3 py-2" placeholder="http://server/api/upload">
                            </div>
                        </div>
                        
                        <!-- MQTT 配置 -->
                        <div id="mqtt-config" class="config-section hidden">
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">Broker地址</label>
                                <input type="text" name="mqttBroker" class="w-full border rounded px-3 py-2" placeholder="tcp://broker.example.com:1883">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">Topic</label>
                                <input type="text" name="mqttTopic" class="w-full border rounded px-3 py-2" placeholder="device/data">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">ClientID</label>
                                <input type="text" name="clientId" class="w-full border rounded px-3 py-2" placeholder="gateway_client">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">用户名</label>
                                <input type="text" name="mqttUsername" class="w-full border rounded px-3 py-2">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">密码</label>
                                <input type="password" name="mqttPassword" class="w-full border rounded px-3 py-2">
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">上报周期 (毫秒)</label>
                            <input type="number" name="upload_interval" class="w-full border rounded px-3 py-2" value="10000">
                        </div>
                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" name="enabled" class="mr-2" checked>
                                <span class="text-sm font-bold">启用</span>
                            </label>
                        </div>
                        <div class="flex justify-end">
                            <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded mr-2" onclick="closeModal()">取消</button>
                            <button type="button" class="bg-blue-500 text-white px-4 py-2 rounded" onclick="submitNorthboundForm()">保存</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal-container').classList.remove('hidden');
        }

        // 切换北向配置显示
        function toggleNorthboundConfig() {
            const type = document.querySelector('select[name="type"]').value;
            document.querySelectorAll('.config-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(type + '-config').classList.remove('hidden');
        }

        // 提交北向配置表单
        function submitNorthboundForm() {
            const form = document.getElementById('northbound-form');
            const formData = new FormData(form);
            const type = formData.get('type');
            
            let config = {};
            if (type === 'xunji') {
                config = {
                    productKey: formData.get('productKey') || '',
                    deviceKey: formData.get('deviceKey') || '',
                    serverUrl: formData.get('serverUrl') || '',
                    username: formData.get('username') || '',
                    password: formData.get('password') || ''
                };
            } else if (type === 'http') {
                config = {
                    url: formData.get('httpUrl') || ''
                };
            } else if (type === 'mqtt') {
                config = {
                    broker: formData.get('mqttBroker') || '',
                    topic: formData.get('mqttTopic') || '',
                    clientId: formData.get('clientId') || '',
                    username: formData.get('mqttUsername') || '',
                    password: formData.get('mqttPassword') || ''
                };
            }
            
            const data = {
                name: formData.get('name'),
                type: type,
                config: JSON.stringify(config),
                upload_interval: parseInt(formData.get('upload_interval') || '10000'),
                enabled: formData.get('enabled') ? 1 : 0
            };
            
            htmx.ajax('POST', '/api/northbound', {
                target: '#northbound-table-body',
                swap: 'innerHTML',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'application/json' }
            }).then(() => {
                closeModal();
                htmx.ajax('GET', '/api/northbound', {
                    target: '#northbound-table-body',
                    swap: 'innerHTML',
                    afterRequest: function(evt) {
                        if (evt.detail.successful) {
                            renderNorthboundTable(evt.detail.xhr.response);
                        }
                    }
                });
            });
        }

        // 渲染设备表格
        function renderDevicesTable(data) {
            try {
                const devices = JSON.parse(data);
                
                // 更新设备统计
                const totalDevices = devices.length;
                const enabledDevices = devices.filter(d => d.enabled === 1).length;
                document.getElementById('devices-container').innerHTML = `
                    <p class="text-2xl font-bold text-blue-600">${totalDevices}</p>
                    <p class="text-sm text-gray-500">总设备数 (启用: ${enabledDevices})</p>
                `;

                // 渲染设备表格
                let html = '';
                devices.forEach(device => {
                    const statusClass = device.enabled === 1 ? 'text-green-600' : 'text-red-600';
                    const statusText = device.enabled === 1 ? '启用' : '禁用';
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${device.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${device.resource_id || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${device.driver_id || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${device.collect_interval}ms</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="editDevice(${device.id})">编辑</button>
                                <button class="text-red-600 hover:text-red-900" onclick="deleteDevice(${device.id})">删除</button>
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('devices-table-body').innerHTML = html || '<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">暂无设备</td></tr>';
            } catch (e) {
                console.error('Failed to parse devices data:', e);
            }
        }

        // 编辑设备
        function editDevice(id) {
            console.log('Edit device:', id);
        }

        // 删除设备
        function deleteDevice(id) {
            if (!confirm('确定要删除此设备吗？')) {
                return;
            }
            htmx.ajax('DELETE', '/api/devices/' + id, {
                target: '#devices-table-body',
                swap: 'innerHTML',
                afterRequest: function(evt) {
                    if (evt.detail.successful) {
                        htmx.ajax('GET', '/api/devices', {
                            target: '#devices-table-body',
                            swap: 'innerHTML',
                            afterRequest: function(e) {
                                if (e.detail.successful) {
                                    renderDevicesTable(e.detail.xhr.response);
                                }
                            }
                        });
                    }
                }
            });
        }

        // 显示设备模态框
        function showDeviceModal() {
            document.getElementById('modal-container').innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <h3 class="text-lg font-bold mb-4">添加设备</h3>
                    <form id="device-form">
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">名称</label>
                            <input type="text" name="name" class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">描述</label>
                            <input type="text" name="description" class="w-full border rounded px-3 py-2">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">采集周期 (毫秒)</label>
                            <input type="number" name="collect_interval" class="w-full border rounded px-3 py-2" value="5000">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">上传周期 (毫秒)</label>
                            <input type="number" name="upload_interval" class="w-full border rounded px-3 py-2" value="10000">
                        </div>
                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" name="enabled" class="mr-2" checked>
                                <span class="text-sm font-bold">启用</span>
                            </label>
                        </div>
                        <div class="flex justify-end">
                            <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded mr-2" onclick="closeModal()">取消</button>
                            <button type="button" class="bg-blue-500 text-white px-4 py-2 rounded" onclick="submitDeviceForm()">保存</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal-container').classList.remove('hidden');
        }

        // 提交设备表单
        function submitDeviceForm() {
            const form = document.getElementById('device-form');
            const formData = new FormData(form);
            
            const data = {
                name: formData.get('name'),
                description: formData.get('description') || '',
                collect_interval: parseInt(formData.get('collect_interval') || '5000'),
                upload_interval: parseInt(formData.get('upload_interval') || '10000'),
                enabled: formData.get('enabled') ? 1 : 0,
                resource_id: null,
                driver_id: null,
                device_config: '{}'
            };
            
            htmx.ajax('POST', '/api/devices', {
                target: '#devices-table',
                swap: 'innerHTML',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'application/json' }
            }).then(() => {
                closeModal();
                htmx.ajax('GET', '/api/devices', { target: '#devices-table' });
            });
        }

        // 显示驱动模态框
        function showDriverModal() {
            document.getElementById('modal-container').innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <h3 class="text-lg font-bold mb-4">添加驱动</h3>
                    <form id="driver-form">
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">名称</label>
                            <input type="text" name="name" class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">文件路径</label>
                            <input type="text" name="file_path" class="w-full border rounded px-3 py-2" placeholder="drivers/th.wasm" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">版本</label>
                            <input type="text" name="version" class="w-full border rounded px-3 py-2" value="1.0">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">描述</label>
                            <input type="text" name="description" class="w-full border rounded px-3 py-2">
                        </div>
                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" name="enabled" class="mr-2" checked>
                                <span class="text-sm font-bold">启用</span>
                            </label>
                        </div>
                        <div class="flex justify-end">
                            <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded mr-2" onclick="closeModal()">取消</button>
                            <button type="button" class="bg-blue-500 text-white px-4 py-2 rounded" onclick="submitDriverForm()">保存</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal-container').classList.remove('hidden');
        }

        // 提交驱动表单
        function submitDriverForm() {
            const form = document.getElementById('driver-form');
            const formData = new FormData(form);
            
            const data = {
                name: formData.get('name'),
                file_path: formData.get('file_path'),
                version: formData.get('version') || '1.0',
                description: formData.get('description') || '',
                config_schema: '{}',
                enabled: formData.get('enabled') ? 1 : 0
            };
            
            htmx.ajax('POST', '/api/drivers', {
                target: '#drivers-table',
                swap: 'innerHTML',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'application/json' }
            }).then(() => {
                closeModal();
                htmx.ajax('GET', '/api/drivers', { target: '#drivers-table' });
            });
        }

        // 显示阈值模态框
        function showThresholdModal() {
            document.getElementById('modal-container').innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <h3 class="text-lg font-bold mb-4">添加阈值</h3>
                    <form id="threshold-form">
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">设备ID</label>
                            <input type="number" name="device_id" class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">字段名</label>
                            <input type="text" name="field_name" class="w-full border rounded px-3 py-2" placeholder="temperature" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">条件</label>
                            <select name="operator" class="w-full border rounded px-3 py-2">
                                <option value=">">大于 (>)</option>
                                <option value="<">小于 (<)</option>
                                <option value=">=">大于等于 (>=)</option>
                                <option value="<=">小于等于 (<=)</option>
                                <option value="==">等于 (==)</option>
                                <option value="!=">不等于 (!=)</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">阈值</label>
                            <input type="number" name="value" step="any" class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">严重程度</label>
                            <select name="severity" class="w-full border rounded px-3 py-2">
                                <option value="info">信息</option>
                                <option value="warning">警告</option>
                                <option value="error">错误</option>
                                <option value="critical">严重</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">消息</label>
                            <input type="text" name="message" class="w-full border rounded px-3 py-2" placeholder="报警描述">
                        </div>
                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" name="enabled" class="mr-2" checked>
                                <span class="text-sm font-bold">启用</span>
                            </label>
                        </div>
                        <div class="flex justify-end">
                            <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded mr-2" onclick="closeModal()">取消</button>
                            <button type="button" class="bg-blue-500 text-white px-4 py-2 rounded" onclick="submitThresholdForm()">保存</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal-container').classList.remove('hidden');
        }

        // 提交阈值表单
        function submitThresholdForm() {
            const form = document.getElementById('threshold-form');
            const formData = new FormData(form);
            
            const data = {
                device_id: parseInt(formData.get('device_id')),
                field_name: formData.get('field_name'),
                operator: formData.get('operator'),
                value: parseFloat(formData.get('value')),
                severity: formData.get('severity'),
                message: formData.get('message') || '',
                enabled: formData.get('enabled') ? 1 : 0
            };
            
            htmx.ajax('POST', '/api/thresholds', {
                target: '#thresholds-table',
                swap: 'innerHTML',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'application/json' }
            }).then(() => {
                closeModal();
                htmx.ajax('GET', '/api/thresholds', { target: '#thresholds-table' });
            });
        }

        // 页面加载时更新状态和表格数据
        document.addEventListener('DOMContentLoaded', function() {
            htmx.ajax('GET', '/api/status', { target: '#collector-status' });
            
            // 加载北向配置数据并渲染
            htmx.ajax('GET', '/api/northbound', {
                target: '#northbound-table-body',
                swap: 'innerHTML',
                afterRequest: function(evt) {
                    if (evt.detail.successful) {
                        renderNorthboundTable(evt.detail.xhr.response);
                    }
                }
            });
            
            // 加载设备数据并渲染
            htmx.ajax('GET', '/api/devices', {
                target: '#devices-table-body',
                swap: 'innerHTML',
                afterRequest: function(evt) {
                    if (evt.detail.successful) {
                        renderDevicesTable(evt.detail.xhr.response);
                    }
                }
            });
        });

        // 渲染北向配置表格
        function renderNorthboundTable(data) {
            try {
                const configs = JSON.parse(data);
                let html = '';
                configs.forEach(config => {
                    const statusText = config.enabled === 1 ? '启用' : '禁用';
                    const statusClass = config.enabled === 1 ? 'text-green-600' : 'text-red-600';
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${config.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${config.type}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${config.productKey || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${config.deviceKey || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${config.upload_interval}ms</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="editNorthboundConfig(${config.id})">编辑</button>
                                <button class="text-red-600 hover:text-red-900" onclick="deleteNorthboundConfig(${config.id})">删除</button>
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('northbound-table-body').innerHTML = html || '<tr><td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">暂无数据</td></tr>';
            } catch (e) {
                console.error('Failed to parse northbound data:', e);
            }
        }

        // 编辑北向配置
        function editNorthboundConfig(id) {
            // 获取配置详情并打开编辑模态框
            htmx.ajax('GET', '/api/northbound', {
                target: 'body',
                swap: 'beforeend',
                afterRequest: function(evt) {
                    if (evt.detail.successful) {
                        try {
                            const configs = JSON.parse(evt.detail.xhr.response);
                            const config = configs.find(c => c.id === id);
                            if (config) {
                                showNorthboundEditModal(config);
                            }
                        } catch (e) {
                            console.error('Failed to parse config:', e);
                        }
                    }
                }
            });
        }

        // 显示编辑北向配置模态框
        function showNorthboundEditModal(config) {
            let configHtml = '';
            if (config.type === 'xunji') {
                configHtml = `
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1">ProductKey</label>
                        <input type="text" id="edit-productKey" name="productKey" class="w-full border rounded px-3 py-2" value="${config.productKey || ''}">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1">DeviceKey</label>
                        <input type="text" id="edit-deviceKey" name="deviceKey" class="w-full border rounded px-3 py-2" value="${config.deviceKey || ''}">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1">服务器地址</label>
                        <input type="text" id="edit-serverUrl" name="serverUrl" class="w-full border rounded px-3 py-2" value="${config.serverUrl || ''}">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1">用户名</label>
                        <input type="text" id="edit-username" name="username" class="w-full border rounded px-3 py-2">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1">密码</label>
                        <input type="password" id="edit-password" name="password" class="w-full border rounded px-3 py-2">
                    </div>
                `;
            } else if (config.type === 'http') {
                configHtml = `
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1">服务器地址</label>
                        <input type="text" name="httpUrl" class="w-full border rounded px-3 py-2" value="${config.serverUrl || ''}">
                    </div>
                `;
            } else if (config.type === 'mqtt') {
                configHtml = `
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1">Broker地址</label>
                        <input type="text" name="mqttBroker" class="w-full border rounded px-3 py-2">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1">Topic</label>
                        <input type="text" name="mqttTopic" class="w-full border rounded px-3 py-2">
                    </div>
                `;
            }

            document.getElementById('modal-container').innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-[500px] shadow-lg rounded-md bg-white">
                    <h3 class="text-lg font-bold mb-4">编辑北向配置</h3>
                    <form id="northbound-edit-form">
                        <input type="hidden" name="id" value="${config.id}">
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">名称</label>
                            <input type="text" name="name" class="w-full border rounded px-3 py-2" value="${config.name}" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">类型</label>
                            <select name="type" class="w-full border rounded px-3 py-2" disabled>
                                <option value="${config.type}">${config.type.toUpperCase()}</option>
                            </select>
                        </div>
                        ${configHtml}
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">上报周期 (毫秒)</label>
                            <input type="number" name="upload_interval" class="w-full border rounded px-3 py-2" value="${config.upload_interval}">
                        </div>
                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" name="enabled" class="mr-2" ${config.enabled === 1 ? 'checked' : ''}>
                                <span class="text-sm font-bold">启用</span>
                            </label>
                        </div>
                        <div class="flex justify-end">
                            <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded mr-2" onclick="closeModal()">取消</button>
                            <button type="button" class="bg-blue-500 text-white px-4 py-2 rounded" onclick="submitNorthboundEditForm()">保存</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal-container').classList.remove('hidden');
        }

        // 提交编辑北向配置表单
        function submitNorthboundEditForm() {
            const form = document.getElementById('northbound-edit-form');
            const formData = new FormData(form);
            const type = formData.get('type');
            
            let config = {};
            if (type === 'xunji') {
                config = {
                    productKey: formData.get('productKey') || '',
                    deviceKey: formData.get('deviceKey') || '',
                    serverUrl: formData.get('serverUrl') || '',
                    username: formData.get('username') || '',
                    password: formData.get('password') || ''
                };
            } else if (type === 'http') {
                config = {
                    url: formData.get('httpUrl') || ''
                };
            } else if (type === 'mqtt') {
                config = {
                    broker: formData.get('mqttBroker') || '',
                    topic: formData.get('mqttTopic') || ''
                };
            }
            
            const data = {
                id: parseInt(formData.get('id')),
                name: formData.get('name'),
                type: type,
                config: JSON.stringify(config),
                upload_interval: parseInt(formData.get('upload_interval') || '10000'),
                enabled: formData.get('enabled') ? 1 : 0
            };
            
            htmx.ajax('PUT', '/api/northbound/' + data.id, {
                target: '#northbound-table-body',
                swap: 'innerHTML',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'application/json' }
            }).then(() => {
                closeModal();
                htmx.ajax('GET', '/api/northbound', {
                    target: '#northbound-table-body',
                    swap: 'innerHTML',
                    afterRequest: function(evt) {
                        if (evt.detail.successful) {
                            renderNorthboundTable(evt.detail.xhr.response);
                        }
                    }
                });
            });
        }

        // 删除北向配置
        function deleteNorthboundConfig(id) {
            if (!confirm('确定要删除此北向配置吗？')) {
                return;
            }
            htmx.ajax('DELETE', '/api/northbound/' + id, {
                target: '#northbound-table-body',
                swap: 'innerHTML',
                afterRequest: function(evt) {
                    if (evt.detail.successful) {
                        htmx.ajax('GET', '/api/northbound', {
                            target: '#northbound-table-body',
                            swap: 'innerHTML',
                            afterRequest: function(e) {
                                if (e.detail.successful) {
                                    renderNorthboundTable(e.detail.xhr.response);
                                }
                            }
                        });
                    }
                }
            });
        }
    </script>
</body>
</html>
