<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HuShu智能网关 - 实时数据</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .htmx-request .htmx-indicator { display: inline; }
        .htmx-indicator { display: none; }
        .value-card {
            transition: all 0.3s ease;
        }
        .value-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen">
    <!-- 顶部导航 -->
    <nav class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-chart-line text-2xl"></i>
                    <h1 class="text-xl font-bold">HuShu智能网关 - 实时监控</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="flex items-center space-x-2 hover:text-blue-200 transition-colors">
                        <i class="fas fa-home"></i>
                        <span>仪表盘</span>
                    </a>
                    <a href="/realtime" class="flex items-center space-x-2 text-white font-bold">
                        <i class="fas fa-chart-line"></i>
                        <span>实时数据</span>
                    </a>
                    <a href="/history" class="flex items-center space-x-2 hover:text-blue-200 transition-colors">
                        <i class="fas fa-history"></i>
                        <span>历史数据</span>
                    </a>
                    <div class="flex items-center space-x-2 bg-blue-700 px-3 py-1 rounded-lg">
                        <i class="fas fa-user-circle"></i>
                        <span>admin</span>
                    </div>
                    <a href="/logout" class="flex items-center space-x-2 bg-red-500 hover:bg-red-600 px-3 py-1 rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>退出</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <div class="container mx-auto px-6 py-8">
        <!-- 设备选择卡片 -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <div class="flex items-center gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-microchip mr-2 text-blue-500"></i>选择设备
                    </label>
                    <div class="relative">
                        <select id="device-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 appearance-none bg-white"
                                onchange="loadDeviceData()">
                            <option value="">-- 请选择设备 --</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </div>
                    </div>
                </div>
                <div class="flex items-end">
                    <button class="btn-primary" onclick="refreshDevices()">
                        <i class="fas fa-sync-alt mr-2"></i>刷新列表
                    </button>
                </div>
            </div>
        </div>

        <!-- 状态指示器 -->
        <div id="refresh-status" class="mb-4 flex items-center text-sm text-gray-500">
            <i class="fas fa-circle text-gray-300 mr-2"></i>
            <span>等待选择设备...</span>
        </div>

        <!-- 实时数据卡片容器 -->
        <div id="realtime-data" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <div class="col-span-full text-center text-gray-500 py-16">
                <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-microchip text-4xl text-gray-300"></i>
                </div>
                <p class="text-lg">请从上方选择设备查看实时数据</p>
            </div>
        </div>
    </div>

    <style>
        .btn-primary { @apply bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-3 rounded-lg shadow transition-all duration-200; }
    </style>

    <!-- 实时刷新脚本 -->
    <script>
        let selectedDeviceId = null;
        let selectedDeviceName = null;
        let refreshInterval = null;

        // 页面加载时获取设备列表
        document.addEventListener('DOMContentLoaded', function() {
            refreshDevices();
        });

        // 刷新设备列表
        function refreshDevices() {
            htmx.ajax('GET', '/api/devices', {
                target: '#device-select',
                swap: 'innerHTML',
                afterRequest: function(evt) {
                    if (evt.detail.successful) {
                        try {
                            const devices = JSON.parse(evt.detail.xhr.response);
                            let html = '<option value="">-- 请选择设备 --</option>';
                            devices.filter(d => d.enabled === 1).forEach(device => {
                                html += `<option value="${device.id}">${device.name}</option>`;
                            });
                            document.getElementById('device-select').innerHTML = html;
                        } catch (e) {
                            console.error('Failed to parse devices:', e);
                        }
                    }
                }
            });
        }

        // 加载设备数据
        function loadDeviceData() {
            const select = document.getElementById('device-select');
            selectedDeviceId = select.value;
            selectedDeviceName = select.options[select.selectedIndex].text;

            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }

            // 更新状态指示器
            const statusEl = document.getElementById('refresh-status');
            if (selectedDeviceId) {
                statusEl.innerHTML = `
                    <i class="fas fa-circle text-green-500 mr-2 pulse-animation"></i>
                    <span>正在监控: <strong class="text-blue-600">${selectedDeviceName}</strong></span>
                    <span class="ml-4 text-gray-400">(每2秒自动刷新)</span>
                `;
                
                // 开始实时刷新
                refreshDeviceData();
                refreshInterval = setInterval(refreshDeviceData, 2000);
            } else {
                statusEl.innerHTML = `
                    <i class="fas fa-circle text-gray-300 mr-2"></i>
                    <span>等待选择设备...</span>
                `;
                
                document.getElementById('realtime-data').innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-16">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-microchip text-4xl text-gray-300"></i>
                        </div>
                        <p class="text-lg">请从上方选择设备查看实时数据</p>
                    </div>
                `;
            }
        }

        // 刷新设备数据
        function refreshDeviceData() {
            if (!selectedDeviceId) return;

            htmx.ajax('GET', '/api/data/cache/' + selectedDeviceId, {
                target: '#realtime-data',
                swap: 'innerHTML',
                afterRequest: function(evt) {
                    if (evt.detail.successful) {
                        try {
                            const data = JSON.parse(evt.detail.xhr.response);
                            renderRealTimeData(data);
                        } catch (e) {
                            console.error('Failed to parse data:', e);
                        }
                    }
                }

        // 渲染实时数据卡片 }
            });
       
        function renderRealTimeData(data) {
            if (!data || data.length === 0) {
                document.getElementById('realtime-data').innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-16">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-exclamation-circle text-4xl text-gray-300"></i>
                        </div>
                        <p class="text-lg">暂无数据，请稍后再试</p>
                    </div>
                `;
                return;
            }

            let html = '';
            data.forEach((item, index) => {
                // 根据字段名生成不同的颜色
                const colors = ['blue', 'green', 'purple', 'orange', 'pink', 'teal'];
                const colorIndex = index % colors.length;
                const colorClass = colors[colorIndex];
                
                // 判断是否为数字值
                const isNumber = !isNaN(parseFloat(item.value));
                const displayValue = isNumber ? parseFloat(item.value).toFixed(2) : item.value;
                const unit = isNumber ? getUnit(item.field_name) : '';

                html += `
                    <div class="value-card bg-white rounded-xl shadow-md p-6 border-t-4 border-${colorClass}-500">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-${colorClass}-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-wave-square text-${colorClass}-500"></i>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">${item.field_name}</div>
                                    <div class="text-xs text-gray-400">设备ID: ${item.device_id}</div>
                                </div>
                            </div>
                            <span class="badge bg-${colorClass}-100 text-${colorClass}-800">实时</span>
                        </div>
                        <div class="text-4xl font-bold text-${colorClass}-600">${displayValue}<span class="text-lg font-normal text-gray-400 ml-1">${unit}</span></div>
                        <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-100">
                            <div class="flex items-center text-xs text-gray-400">
                                <i class="far fa-clock mr-1"></i>
                                ${new Date(item.updated_at || item.collected_at).toLocaleString()}
                            </div>
                            <div class="flex items-center text-xs text-green-500">
                                <i class="fas fa-check-circle mr-1"></i>
                                已更新
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('realtime-data').innerHTML = html;
        }

        // 获取单位
        function getUnit(fieldName) {
            fieldName = fieldName.toLowerCase();
            if (fieldName.includes('temp') || fieldName.includes('温度')) return '°C';
            if (fieldName.includes('hum') || fieldName.includes('湿度')) return '%';
            if (fieldName.includes('press') || fieldName.includes('压力')) return 'Pa';
            if (fieldName.includes('volt') || fieldName.includes('电压')) return 'V';
            if (fieldName.includes('curr') || fieldName.includes('电流')) return 'A';
            if (fieldName.includes('power') || fieldName.includes('功率')) return 'W';
            return '';
        }
    </script>
</body>
</html>
