<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HuShu智能网关 - 实时数据</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #0a0a1a 100%);
            min-height: 100vh;
            color: #fff;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }
        
        .nav {
            background: rgba(10, 15, 35, 0.95);
            border-bottom: 1px solid rgba(0, 198, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 50;
            padding: 16px 0;
        }
        .nav-inner { display: flex; justify-content: space-between; align-items: center; }
        .nav-brand { display: flex; align-items: center; gap: 16px; }
        .nav-logo {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .nav-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #00c6ff, #00ffff, #8a2be2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .nav-subtitle { font-size: 12px; color: #9ca3af; display: flex; align-items: center; gap: 8px; }
        .nav-subtitle span { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; animation: pulse 2s infinite; }
        .nav-links { display: flex; gap: 24px; align-items: center; }
        .nav-link {
            color: rgba(0, 198, 255, 0.6);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
        }
        .nav-link:hover, .nav-link.active { color: #00c6ff; }
        .nav-link.active { background: rgba(0, 198, 255, 0.1); }
        .nav-user {
            display: flex; align-items: center; gap: 12px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        .nav-user-avatar {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
        }
        
        .card {
            background: rgba(10, 15, 35, 0.9);
            border: 1px solid rgba(0, 198, 255, 0.15);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
        }
        .btn-primary { background: rgba(0, 198, 255, 0.1); border-color: rgba(0, 198, 255, 0.3); color: #00c6ff; }
        .btn-success { background: rgba(0, 255, 127, 0.1); border-color: rgba(0, 255, 127, 0.3); color: #00ff7f; }
        
        .select { width: 100%; padding: 12px 16px; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(0, 198, 255, 0.2); border-radius: 10px; color: #fff; font-size: 14px; }
        
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        .gap-4 { gap: 16px; }
        .gap-6 { gap: 24px; }
        
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .mt-4 { margin-top: 16px; }
        .p-4 { padding: 16px; }
        .p-6 { padding: 24px; }
        .p-16 { padding: 64px; }
        
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .space-x-2 { gap: 8px; }
        .space-x-4 { gap: 16px; }
        
        .text-white { color: #fff; }
        .text-gray-300 { color: #d1d5db; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-600 { color: #4b5563; }
        .text-blue-400 { color: #60a5fa; }
        .text-green-400 { color: #4ade80; }
        .text-xl { font-size: 20px; }
        .text-2xl { font-size: 24px; }
        .text-5xl { font-size: 48px; }
        .font-semibold { font-weight: 600; }
        
        .hidden { display: none; }
        .w-full { width: 100%; }
        .rounded-lg { border-radius: 10px; }
        .rounded-xl { border-radius: 16px; }
        .rounded-full { border-radius: 9999px; }
        
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        @media (min-width: 768px) { .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (min-width: 1024px) { .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        @media (min-width: 1280px) { .xl\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #00c6ff, #8a2be2); border-radius: 4px; }
        
        .border-glow { position: relative; }
        .border-glow::before {
            content: ''; position: absolute; inset: 0; border-radius: inherit; padding: 1px;
            background: linear-gradient(135deg, #00c6ff, #00ffff, #8a2be2, #00c6ff);
            background-size: 300% 300%; animation: border-rotate 4s linear infinite;
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude;
        }
        @keyframes border-rotate { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .data-card {
            background: rgba(10, 15, 35, 0.9);
            border: 1px solid rgba(0, 198, 255, 0.15);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s;
        }
        .data-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, var(--card-color), transparent);
        }
        .data-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4); }
        .data-card { position: relative; }
        
        .data-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .data-label { font-size: 14px; color: #d1d5db; font-weight: 500; }
        .data-device { font-size: 12px; color: #6b7280; margin-top: 4px; }
        .data-value { font-size: 40px; font-weight: 700; font-family: monospace; margin: 16px 0; letter-spacing: 2px; }
        .data-unit { font-size: 20px; font-weight: 400; color: #6b7280; margin-left: 4px; }
        .data-footer { display: flex; justify-content: space-between; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 12px; color: #6b7280; }
        
        .empty-state { text-align: center; padding: 64px 32px; }
        .empty-icon { width: 96px; height: 96px; border-radius: 50%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; font-size: 48px; color: #4b5563; }
        
        .status-online { width: 12px; height: 12px; border-radius: 50%; background: #4ade80; animation: pulse 2s infinite; }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <nav class="nav">
        <div class="container nav-inner">
            <div class="nav-brand">
                <div class="nav-logo">&#128200;</div>
                <div>
                    <div class="nav-title">HuShu智能网关</div>
                    <div class="nav-subtitle"><span></span>实时数据监控</div>
                </div>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">&#8962; 仪表盘</a>
                <a href="/realtime" class="nav-link active">&#128200; 实时数据</a>
                <a href="/history" class="nav-link">&#128337; 历史数据</a>
                <div class="nav-user">
                    <div class="nav-user-avatar">&#128100;</div>
                    <span class="text-gray-300">admin</span>
                </div>
                <a href="/logout" class="btn" style="background: rgba(255,0,63,0.1); border-color: rgba(255,0,63,0.3); color: #ff003f; padding: 8px 16px;">&#10145; 退出</a>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <main class="container" style="padding-top: 32px; padding-bottom: 32px;">
        <!-- 设备选择 -->
        <div class="card border-glow mb-6">
            <div class="flex items-center space-x-4">
                <div style="flex: 1;">
                    <label style="display: block; font-size: 14px; color: #d1d5db; margin-bottom: 8px;">&#128268; 选择设备</label>
                    <select id="device-select" class="select" onchange="loadDeviceData()">
                        <option value="">-- 请选择设备 --</option>
                    </select>
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button class="btn btn-success" onclick="refreshDevices()">&#8635; 刷新列表</button>
                </div>
            </div>
        </div>
        
        <!-- 状态指示 -->
        <div id="refresh-status" class="mb-4 flex items-center" style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #9ca3af;">
            <span style="width: 8px; height: 8px; background: #6b7280; border-radius: 50%;"></span>
            <span>等待选择设备...</span>
        </div>
        
        <!-- 实时数据 -->
        <div id="realtime-data" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <div class="col-span-full card border-glow p-16 text-center">
                <div class="empty-state">
                    <div class="empty-icon">&#128268;</div>
                    <p class="text-xl text-gray-400 mb-2">请从上方选择设备查看实时数据</p>
                    <p class="text-sm text-gray-600">系统将每2秒自动刷新数据</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        var selectedDeviceId = null;
        var selectedDeviceName = null;
        var refreshInterval = null;
        
        function api(url, options) {
            return fetch(url, options).then(function(res) {
                if (!res.ok) throw new Error();
                return res.json();
            });
        }
        
        function refreshDevices() {
            api('/api/devices').then(function(devices) {
                var select = document.getElementById('device-select');
                var html = '<option value="">-- 请选择设备 --</option>';
                for (var i = 0; i < devices.length; i++) {
                    if (devices[i].enabled === 1) {
                        html += '<option value="' + devices[i].id + '">' + devices[i].name + '</option>';
                    }
                }
                select.innerHTML = html;
            });
        }
        
        function loadDeviceData() {
            var select = document.getElementById('device-select');
            selectedDeviceId = select.value;
            selectedDeviceName = select.options[select.selectedIndex] ? select.options[select.selectedIndex].text : '';
            
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            
            var statusEl = document.getElementById('refresh-status');
            if (selectedDeviceId) {
                statusEl.innerHTML = '<span class="status-online"></span><span style="color:#4ade80;">正在监控:</span><span style="color:#fff;margin-left:8px;font-weight:600;">' + selectedDeviceName + '</span><span style="color:#6b7280;margin-left:16px;">(每2秒自动刷新)</span>';
                refreshDeviceData();
                refreshInterval = setInterval(refreshDeviceData, 2000);
            } else {
                statusEl.innerHTML = '<span style="width:8px;height:8px;background:#6b7280;border-radius:50%;"></span><span>等待选择设备...</span>';
                document.getElementById('realtime-data').innerHTML = '<div class="col-span-full card border-glow p-16 text-center"><div class="empty-state"><div class="empty-icon">&#128268;</div><p class="text-xl text-gray-400 mb-2">请从上方选择设备查看实时数据</p><p class="text-sm text-gray-600">系统将每2秒自动刷新数据</p></div></div>';
            }
        }
        
        function refreshDeviceData() {
            if (!selectedDeviceId) return;
            api('/api/data/cache/' + selectedDeviceId).then(renderRealTimeData);
        }
        
        function renderRealTimeData(data) {
            var container = document.getElementById('realtime-data');
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="col-span-full card border-glow p-16 text-center"><div class="empty-state"><div class="empty-icon">&#9888;</div><p class="text-xl text-gray-400 mb-2">暂无数据，请稍后再试</p><p class="text-sm text-gray-600">请确保设备已启用并正在采集数据</p></div></div>';
                return;
            }
            
            var colors = [
                { name: 'blue', color: '#3b82f6', bg: 'rgba(59, 130, 246, 0.2)', text: '#60a5fa' },
                { name: 'green', color: '#22c55e', bg: 'rgba(34, 197, 94, 0.2)', text: '#4ade80' },
                { name: 'purple', color: '#a855f7', bg: 'rgba(168, 85, 247, 0.2)', text: '#c084fc' },
                { name: 'orange', color: '#f97316', bg: 'rgba(249, 115, 22, 0.2)', text: '#fb923c' },
                { name: 'pink', color: '#ec4899', bg: 'rgba(236, 72, 153, 0.2)', text: '#f472b6' },
                { name: 'teal', color: '#14b8a6', bg: 'rgba(20, 184, 166, 0.2)', text: '#2dd4bf' },
            ];
            
            var html = '';
            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                var color = colors[i % colors.length];
                var isNumber = !isNaN(parseFloat(item.value));
                var displayValue = isNumber ? parseFloat(item.value).toFixed(2) : item.value;
                var unit = isNumber ? getUnit(item.field_name) : '';
                var timeStr = new Date(item.updated_at || item.collected_at).toLocaleString('zh-CN');
                
                html += '<div class="data-card border-glow" style="--card-color:' + color.color + ';">';
                html += '<div class="flex justify-between items-start">';
                html += '<div class="flex items-center gap-3">';
                html += '<div class="data-icon" style="background:' + color.bg + ';color:' + color.text + ';">&#128200;</div>';
                html += '<div><div class="data-label">' + item.field_name + '</div><div class="data-device">' + (item.device_name || '设备ID: ' + item.device_id) + '</div></div>';
                html += '</div>';
                html += '<div style="background:' + color.bg + ';color:' + color.text + ';padding:4px 12px;border-radius:9999px;font-size:12px;display:flex;align-items:center;gap:6px;"><span style="width:8px;height:8px;background:currentColor;border-radius:50%;animation:pulse 2s infinite;"></span>实时</div>';
                html += '</div>';
                html += '<div class="data-value" style="color:' + color.text + ';">' + displayValue + '<span class="data-unit">' + unit + '</span></div>';
                html += '<div class="data-footer"><div style="display:flex;align-items:center;gap:4px;">&#128337; ' + timeStr + '</div><div style="display:flex;align-items:center;gap:4px;color:' + color.text + ';">&#8635; 已更新</div></div>';
                html += '</div>';
            }
            container.innerHTML = html;
        }
        
        function getUnit(fieldName) {
            fieldName = (fieldName || '').toLowerCase();
            if (fieldName.includes('temp') || fieldName.includes('温度')) return 'C';
            if (fieldName.includes('hum') || fieldName.includes('湿度')) return '%';
            if (fieldName.includes('press') || fieldName.includes('压力')) return 'Pa';
            if (fieldName.includes('volt') || fieldName.includes('电压')) return 'V';
            if (fieldName.includes('curr') || fieldName.includes('电流')) return 'A';
            if (fieldName.includes('power') || fieldName.includes('功率')) return 'W';
            if (fieldName.includes('speed') || fieldName.includes('速度')) return 'm/s';
            if (fieldName.includes('level') || fieldName.includes('液位')) return 'm';
            if (fieldName.includes('flow') || fieldName.includes('流量')) return 'm/h';
            return '';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            refreshDevices();
        });
    </script>
</body>
</html>
